<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Conway's Game of Life — WebSocket</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --bg: #111;
            --accent: #00ff66;
            --panel: #222;
            --mono: "Courier New", Courier, monospace;
        }

        .theme-dark {
            --bg: #111;
            --accent: #00ff66;
            --panel: #222;
        }

        .theme-high-contrast {
            --bg: #000;
            --accent: #fff;
            --panel: #333;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--accent);
            font-family: var(--mono);
        }

        .wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            padding: 12px;
            height: 100%;
            box-sizing: border-box;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        button,
        select {
            background: var(--accent);
            color: #111;
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover,
        select:hover {
            filter: brightness(.95);
        }

        .panel {
            background: var(--panel);
            border: 2px solid var(--accent);
            padding: 10px;
            border-radius: 8px;
            width: calc(100% - 32px);
            max-width: 1500px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        #grid {
            background: #000;
            color: var(--accent);
            padding: 8px;
            border-radius: 6px;
            font-family: var(--mono);
            font-size: 10px;
            line-height: 1;
            white-space: pre;
            overflow: auto;
            flex: 1;
        }

        .status {
            font-size: 13px;
            color: var(--accent);
        }

        .right-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div style="width:100%; max-width:1500px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">Conway's Game of Life</h2>
            <div>
                <div class="status" id="status">Connecting...</div>
                <div id="stats">Generation: 0 | Population: 0</div>
            </div>
        </div>

        <div class="controls">
            <div>
                <button id="glider">Glider</button>
                <button id="blinker">Blinker</button>
                <button id="toad">Toad</button>
                <button id="beacon">Beacon</button>
                <button id="random">Random</button>
            </div>

            <div>
                <label for="speedSlider">Speed: </label>
                <input type="range" id="speedSlider" min="10" max="500" value="100">
                <span id="speedValue">100ms</span>
            </div>

            <div>
                <label for="themeSelect">Theme: </label>
                <select id="themeSelect">
                    <option value="theme-dark">Dark</option>
                    <option value="theme-high-contrast">High Contrast</option>
                </select>
            </div>

            <div class="right-controls">
                <button id="start">Start</button>
                <button id="stop">Stop</button>
            </div>
        </div>

        <div class="panel">
            <div id="grid">Connecting to server...</div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const gridEl = document.getElementById('grid');
        const statsEl = document.getElementById('stats');
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const gliderBtn = document.getElementById('glider');
        const blinkerBtn = document.getElementById('blinker');
        const toadBtn = document.getElementById('toad');
        const beaconBtn = document.getElementById('beacon');
        const randomBtn = document.getElementById('random');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const themeSelect = document.getElementById('themeSelect');

        function getGridSize() {
            // Create a temporary element to measure character size
            const measureEl = document.createElement('span');
            measureEl.style.fontFamily = getComputedStyle(gridEl).fontFamily;
            measureEl.style.fontSize = getComputedStyle(gridEl).fontSize;
            measureEl.style.lineHeight = getComputedStyle(gridEl).lineHeight;
            measureEl.style.position = 'absolute';
            measureEl.style.visibility = 'hidden';
            measureEl.textContent = '█';
            document.body.appendChild(measureEl);
            const charWidth = measureEl.offsetWidth;
            const charHeight = measureEl.offsetHeight;
            document.body.removeChild(measureEl);

            // Get the available space in the grid element
            const availableWidth = gridEl.clientWidth;
            const availableHeight = gridEl.clientHeight;

            const cols = Math.floor(availableWidth / charWidth);
            const rows = Math.floor(availableHeight / charHeight);

            return { width: cols, height: rows };
        }

        function sendResize() {
            const size = getGridSize();
            socket.send(JSON.stringify({ type: 'resize', width: size.width, height: size.height }));
        }

        function applyTheme(theme) {
            document.documentElement.className = theme;
            localStorage.setItem('theme', theme);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'theme-dark';
        applyTheme(savedTheme);
        themeSelect.value = savedTheme;

        const loc = window.location;
        const protocol = loc.protocol === "https:" ? "wss:" : "ws:";
        const socket = new WebSocket(`${protocol}//${loc.host}/ws`);

        socket.addEventListener('open', () => {
            statusEl.textContent = 'Connected';
            statusEl.style.color = '#00ff66';

            // Send initial resolution based on viewport
            sendResize();
        });

        socket.addEventListener('message', (evt) => {
            try {
                const msg = JSON.parse(evt.data);
                gridEl.textContent = msg.grid;
                statsEl.textContent = `Generation: ${msg.generation} | Population: ${msg.population}`;
            } catch (e) {
                // fallback for plain text
                gridEl.textContent = evt.data;
            }
            // keep scrolled to top-left ideally (no auto-scroll)
            gridEl.scrollTop = 0;
            gridEl.scrollLeft = 0;
        });

        socket.addEventListener('close', () => {
            statusEl.textContent = 'Disconnected';
            statusEl.style.color = '#ff4444';
        });

        socket.addEventListener('error', (e) => {
            console.error('WS error', e);
            statusEl.textContent = 'Error';
            statusEl.style.color = '#ff4444';
        });

        window.addEventListener('resize', () => {
            if (socket.readyState === WebSocket.OPEN) {
                sendResize();
            }
        });

        startBtn.addEventListener('click', () => socket.send('start'));
        stopBtn.addEventListener('click', () => socket.send('stop'));

        gliderBtn.addEventListener('click', () => socket.send(JSON.stringify({ type: 'pattern', pattern: 'glider' })));
        blinkerBtn.addEventListener('click', () => socket.send(JSON.stringify({ type: 'pattern', pattern: 'blinker' })));
        toadBtn.addEventListener('click', () => socket.send(JSON.stringify({ type: 'pattern', pattern: 'toad' })));
        beaconBtn.addEventListener('click', () => socket.send(JSON.stringify({ type: 'pattern', pattern: 'beacon' })));
        randomBtn.addEventListener('click', () => socket.send(JSON.stringify({ type: 'pattern', pattern: 'random' })));

        speedSlider.addEventListener('input', () => {
            const val = speedSlider.value;
            speedValue.textContent = val + 'ms';
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'speed', speed: parseInt(val) }));
            }
        });

        themeSelect.addEventListener('change', () => {
            applyTheme(themeSelect.value);
        });

        
    </script>
</body>

</html>
